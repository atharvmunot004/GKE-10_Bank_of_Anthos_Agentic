micro-service-description:
|-> receive: {
|     accountid, 
|     amount
|   } header includes the JWT access token
|   from investment-manager-svc
|   |-> checks the balance by calling balancereader microservice for the account's current balance
|   |   |-> request:
|   |   |   using the JWT token received from invesment-manager-svc
|   |   |-> gets the balance of that account
|   |   |-> iff the balance of the account if >= amount processed
|   |-> calls the user-tier-agent 
|   |   |-> request: 
|   |   |   using the JWT token received from invesment-manager-svc
|   |   |   {
|   |   |     accountid,
|   |   |     amount,
|   |   |     uuid [generate this, this will not be generated anywhere else],
|   |   |     purpose: "INVEST"
|   |   |   }
|   |   |-> return:
|   |       {
|   |         accountid,
|   |         amount,
|   |         uuid,
|   |         tier1,
|   |         tier2,
|   |         tier3,
|   |       }
|   |-> adds {accountid, amount, uuid, + tier1, + tier2, + tier3, transaction_type: INVEST, created_at: TIMESTAMPTZ, status: PENDING} to user-portfolio-db table portfolio-Transactions
|   |-> update user-portfolio-db table user-portfolios accountid:
|       {
|         tier1_allocation = tier1_allocation + tier1,
|         tier2_allocation = tier2_allocation + tier2,
|         tier3_allocation = tier3_allocation + tier3
|       }
|-> returns status to invesment-manager-svc

--- created by Chinmay and Atharv for agent 
--------------------------------------------------------------
--- created by agent for agent

# Invest Service (invest-svc) - AI Agent Documentation

## Service Overview
The invest-svc microservice is a critical component of the Bank of Anthos portfolio management system. It handles investment processing by integrating with the user-tier-agent and updating the user-portfolio-db database.

## Core Functionality
- **Investment Processing**: Accepts investment requests with account number and amount
- **Balance Verification**: Checks account balance via balancereader service
- **Tier Allocation**: Calls user-tier-agent to determine tier1, tier2, tier3 fund allocations
- **Portfolio Management**: Creates or updates user portfolios in user-portfolio-db
- **Transaction Recording**: Maintains audit trail of all investment transactions

## Service Architecture
```
Client Request → invest-svc → user-tier-agent → user-portfolio-db
                     ↓              ↓              ↓
              Process Investment → Get Allocations → Update Portfolio
```

## API Endpoints

### POST /api/v1/invest
**Purpose**: Process an investment request
**Method**: POST
**Content-Type**: application/json
**Authentication**: JWT token forwarded from investment-manager-svc

**Request Body**:
```json
{
  "account_number": "string (required)",
  "amount": "float (required, must be > 0)"
}
```

**Success Response (200)**:
```json
{
  "status": "done",
  "portfolio_id": "uuid",
  "transaction_id": "uuid",
  "total_invested": 1000.0,
  "tier1_amount": 600.0,
  "tier2_amount": 300.0,
  "tier3_amount": 100.0,
  "message": "Investment processed successfully"
}
```

**Error Responses**:
- 400: Invalid input (missing account_number or amount ≤ 0)
- 400: Insufficient balance for investment
- 500: Processing error (database or user-tier-agent unavailable)

### GET /api/v1/portfolio/{user_id}
**Purpose**: Retrieve user portfolio information
**Method**: GET

**Success Response (200)**:
```json
{
  "id": "uuid",
  "user_id": "string",
  "total_value": 1000.0,
  "currency": "USD",
  "tier1_allocation": 60.0,
  "tier2_allocation": 30.0,
  "tier3_allocation": 10.0,
  "tier1_value": 600.0,
  "tier2_value": 300.0,
  "tier3_value": 100.0,
  "created_at": "timestamp",
  "updated_at": "timestamp"
}
```

**Error Responses**:
- 404: Portfolio not found
- 500: Internal server error

### GET /api/v1/portfolio/{user_id}/transactions
**Purpose**: Retrieve user portfolio transactions
**Method**: GET

**Success Response (200)**:
```json
[
  {
    "id": "uuid",
    "transaction_type": "DEPOSIT",
    "tier1_change": 600.0,
    "tier2_change": 300.0,
    "tier3_change": 100.0,
    "total_amount": 1000.0,
    "fees": 0.0,
    "status": "PENDING",
    "created_at": "timestamp",
    "updated_at": "timestamp"
  }
]
```

### GET /health
**Purpose**: Health check endpoint
**Method**: GET
**Response**: `{"status": "healthy"}`

### GET /ready
**Purpose**: Readiness check endpoint
**Method**: GET
**Response**: `{"status": "ready"}` or `{"status": "not ready", "error": "..."}`

## JWT Authentication Integration

### JWT Token Flow
The invest-svc receives JWT tokens from investment-manager-svc and forwards them to external services:

```
Frontend → investment-manager-svc → invest-svc → user-tier-agent/balancereader
    ↓              ↓                    ↓              ↓
JWT Token    JWT Token           JWT Token      JWT Token
```

### Authentication Headers
```python
def get_auth_headers_from_request(request) -> dict:
    auth_header = request.headers.get('Authorization')
    if auth_header and auth_header.startswith('Bearer '):
        token = auth_header.split(' ', 1)[1]
        return {
            'Authorization': f'Bearer {token}',
            'Content-Type': 'application/json'
        }
    return {'Content-Type': 'application/json'}
```

## Database Schema Integration

### Tables Used
1. **user_portfolios**: Main portfolio data storage
   - Stores user investment allocations across tier1, tier2, tier3
   - Tracks total portfolio value and individual tier values
   - Maintains allocation percentages (must sum to 100%)

2. **portfolio_transactions**: Transaction audit trail
   - Records all investment transactions
   - Tracks tier allocation changes
   - Maintains transaction status and timestamps

### Database Operations
- **Portfolio Creation**: Creates new portfolio for first-time investors
- **Portfolio Updates**: Adds new investments to existing portfolios
- **Transaction Recording**: Logs all investment activities
- **Allocation Calculation**: Automatically calculates tier percentages

## Service Dependencies

### Required Services
1. **user-portfolio-db**: PostgreSQL database
   - Connection: `USER_PORTFOLIO_DB_URI` environment variable
   - Purpose: Portfolio data storage and retrieval

2. **user-tier-agent**: Tier allocation service
   - Connection: `USER_TIER_AGENT_URI` environment variable
   - Endpoint: `POST /allocate`
   - Purpose: Determines fund tier allocations

3. **balancereader**: Account balance service
   - Connection: `BALANCE_READER_URI` environment variable
   - Endpoint: `GET /balances/{account_id}`
   - Purpose: Verifies account has sufficient balance

### Environment Variables
- `USER_PORTFOLIO_DB_URI`: Database connection string
- `USER_TIER_AGENT_URI`: User tier agent service URL
- `BALANCE_READER_URI`: Balance reader service URL
- `PORT`: Service port (default: 8080)
- `REQUEST_TIMEOUT`: Request timeout in seconds (default: 30)

## Business Logic

### Investment Processing Flow
1. **Validation**: Validate account_number and amount parameters
2. **Balance Check**: Call balancereader to verify sufficient funds
3. **Tier Allocation**: Call user-tier-agent with account_number and amount
4. **Portfolio Lookup**: Check if user has existing portfolio
5. **Portfolio Update**: Create new or update existing portfolio
6. **Transaction Recording**: Log the investment transaction
7. **Response**: Return investment result with allocation details

### Tier Allocation Rules
- All investments are allocated across three tiers: tier1, tier2, tier3
- Allocation percentages must sum to exactly 100%
- Tier amounts are calculated by user-tier-agent based on user profile
- Portfolio values are updated by adding new tier amounts to existing values

### Error Handling
- **Input Validation**: Rejects invalid account numbers or amounts
- **Balance Verification**: Ensures sufficient account balance
- **Service Dependencies**: Handles user-tier-agent and balancereader unavailability
- **Database Errors**: Manages database connection and transaction failures
- **Data Consistency**: Ensures portfolio data integrity

## Integration Patterns

### For investment-manager-svc
When calling invest-svc from investment-manager-svc:

```python
# Example integration
auth_headers = get_auth_headers_from_request(request)
invest_response = requests.post(
    f'{INVEST_SVC_URI}/api/v1/invest',
    json=invest_request,
    headers=auth_headers,
    timeout=REQUEST_TIMEOUT
)
```

### For New Microservices
When creating microservices that need to process investments:

1. **Use invest-svc API**: Call POST /api/v1/invest endpoint
2. **Handle Responses**: Process success/error responses appropriately
3. **Error Handling**: Implement retry logic for service unavailability
4. **Data Validation**: Validate inputs before calling invest-svc

### For Frontend Applications
- **Investment Forms**: Submit to invest-svc /api/v1/invest endpoint
- **Portfolio Display**: Fetch data from /api/v1/portfolio/{user_id} endpoint
- **Error Handling**: Display appropriate error messages to users
- **Loading States**: Handle async investment processing

## Deployment Information

### Container Details
- **Base Image**: python:3.11-slim
- **Port**: 8080
- **Health Checks**: /health and /ready endpoints
- **Security**: Non-root user, read-only filesystem

### Kubernetes Configuration
- **Service Type**: ClusterIP
- **Replicas**: 1 (configurable)
- **Resources**: 100m CPU, 128Mi memory (requests)
- **Security Context**: Non-root user (1000:1000)

### Deployment Commands
```bash
# Using Kubernetes manifests
kubectl apply -f kubernetes-manifests/invest-svc.yaml

# Using Skaffold (development)
cd src/invest-svc && skaffold run

# Using Kustomize
kubectl apply -k src/invest-svc/k8s/overlays/development
```

## Testing

### Manual Testing
```bash
# Health check
curl http://invest-svc:8080/health

# Process investment
curl -X POST http://invest-svc:8080/api/v1/invest \
  -H "Content-Type: application/json" \
  -d '{"account_number": "1234567890", "amount": 1000.0}'

# Get portfolio
curl http://invest-svc:8080/api/v1/portfolio/1234567890
```

## Security Considerations

### Authentication
- Service uses JWT token forwarding from investment-manager-svc
- No direct external authentication required
- JWT tokens validated by upstream services

### Data Protection
- Database connections use encrypted connections
- Sensitive data (account numbers) logged minimally
- Input validation prevents injection attacks

### Network Security
- Service exposed only within cluster (ClusterIP)
- No external access without ingress configuration
- Communication with dependencies over internal network

## Monitoring and Observability

### Health Checks
- **Liveness Probe**: /health endpoint
- **Readiness Probe**: /ready endpoint (includes database connectivity)

### Logging
- Structured logging with service name
- Request/response logging for audit
- Error logging with stack traces

### Metrics
- Investment processing success/failure rates
- Database connection health
- User-tier-agent response times
- Portfolio creation/update counts

## Troubleshooting

### Common Issues
1. **Database Connection Failed**: Check USER_PORTFOLIO_DB_URI configuration
2. **User Tier Agent Unavailable**: Verify USER_TIER_AGENT_URI and service status
3. **Balance Reader Unavailable**: Check BALANCE_READER_URI and service status
4. **Portfolio Not Found**: Ensure user has existing portfolio or create new one
5. **Invalid Allocation**: Verify tier allocations sum to 100%

### Debug Commands
```bash
# Check service status
kubectl get pods -l app=invest-svc

# View logs
kubectl logs -l app=invest-svc

# Check service endpoints
kubectl get svc invest-svc

# Test connectivity
kubectl exec -it <pod-name> -- curl http://localhost:8080/health
```

## Future Enhancements

### Planned Features
- **Batch Processing**: Support multiple investments in single request
- **Investment History**: Enhanced transaction history queries
- **Portfolio Analytics**: Advanced portfolio performance metrics
- **Notification Service**: Investment confirmation notifications

### Extension Points
- **Custom Tier Logic**: Pluggable tier allocation algorithms
- **Multi-Currency Support**: Support for different currencies
- **Risk Assessment**: Integration with risk analysis services
- **Compliance Checks**: Regulatory compliance validation

## Contact and Support

### Service Owner
- **Team**: Portfolio Management
- **Tier**: Backend
- **Application**: bank-of-anthos

### Documentation
- **README**: src/invest-svc/README.md
- **API Docs**: This file (llm.txt)
- **Code**: src/invest-svc/invest_svc.py

### Related Services
- **user-portfolio-db**: Portfolio data storage
- **user-tier-agent**: Tier allocation service
- **balancereader**: Account balance service
- **investment-manager-svc**: Service orchestrator
- **frontend**: User interface

---

*This documentation is designed for AI agents to understand and integrate with the invest-svc microservice. For human developers, refer to the README.md file in the service directory.*
