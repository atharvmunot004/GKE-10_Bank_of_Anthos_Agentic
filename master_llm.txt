# Bank of Anthos - Master Microservices Architecture

## Project Overview
Bank of Anthos is a comprehensive cloud-native banking platform with AI-powered portfolio management, investment services, and traditional banking operations. The system consists of multiple microservices organized in a sophisticated architecture supporting real-time investment decisions, user portfolio management, and financial transactions.

## Architecture Flow
The system follows a hierarchical architecture where services communicate through well-defined interfaces:

```
loadgen â†’ frontend â†’ [userservice, contacts, ledger writer, balance reader, transaction history, investment-manager-svc]
                    â†“
            [account-db, ledger-db, user-tier-agent, investments-record-reader-svc, user-portfolio-svc, invest-svc, withdraw-svc]
                    â†“
            [assets-db, queue-db, user-portfolio-table, portfolio-transaction-table, bank-asset-agent, rule-checker-svc, execute-order-svc, user-request-queue-svc, user-return-rules-agent, market-reader-svc]
```

## Microservices Catalog

### 1. EXISTING SERVICES (Implemented)

#### 1.1 Load Generator (`loadgen`)
**Status**: âœ… Implemented
**Purpose**: Performance testing and load generation
**Port**: `8080`
**Dependencies**: `frontend`
**Location**: `src/loadgenerator/`
**Description**: Generates synthetic load for testing the frontend and overall system performance.

#### 1.2 Frontend (`frontend`)
**Status**: âœ… Implemented
**Purpose**: Web user interface and API gateway
**Port**: `8080`
**Dependencies**: `userservice`, `contacts`, `ledger writer`, `balance reader`, `transaction history`, `investment-manager-svc`
**Location**: `src/frontend/`
**Description**: Main web interface providing user authentication, account management, transaction history, and investment management features.

#### 1.3 User Service (`userservice`)
**Status**: âœ… Implemented
**Purpose**: User authentication and JWT token management
**Port**: `8080`
**Dependencies**: `account-db`
**Location**: `src/accounts/userservice/`
**Description**: Handles user registration, authentication, JWT token generation and validation.

#### 1.4 Contacts Service (`contacts`)
**Status**: âœ… Implemented
**Purpose**: User contact management for transfers
**Port**: `8080`
**Dependencies**: `account-db`
**Location**: `src/accounts/contacts/`
**Description**: Manages user contacts for quick transfers and external account references.

#### 1.5 Ledger Writer (`ledger writer`)
**Status**: âœ… Implemented
**Purpose**: Transaction recording and ledger management
**Port**: `8080`
**Dependencies**: `ledger-db`
**Location**: `src/ledger/ledgerwriter/`
**Description**: Records all financial transactions in the immutable ledger database.

#### 1.6 Balance Reader (`balance reader`)
**Status**: âœ… Implemented
**Purpose**: Account balance retrieval and calculation
**Port**: `8080`
**Dependencies**: `ledger-db`, `user-tier-agent`
**Location**: `src/ledger/balancereader/`
**Description**: Calculates and retrieves account balances from transaction history.

#### 1.7 Transaction History (`transaction history`)
**Status**: âœ… Implemented
**Purpose**: Transaction history retrieval and reporting
**Port**: `8080`
**Dependencies**: `ledger-db`, `user-tier-agent`
**Location**: `src/ledger/transactionhistory/`
**Description**: Provides transaction history and reporting capabilities.

#### 1.8 Bank Asset Agent (`bank-asset-agent`)
**Status**: âœ… Implemented
**Purpose**: AI-powered asset management, market analysis, and investment decision-making
**Port**: `8080`
**Protocol**: gRPC + HTTP REST
**Dependencies**: `market-reader-svc`, `rule-checker-svc`, `execute-order-svc`, `assets-db`, `user-request-queue-svc`
**Location**: `src/bank-asset-agent/`
**Description**: Comprehensive AI agent that manages investment assets, analyzes market data, and executes investment decisions with full API implementation.

**Key Features**:
- **Market Analysis**: Real-time market data processing and trend analysis
- **Rule Validation**: Investment rule checking and compliance validation
- **Order Execution**: Investment order processing and management
- **Asset Management**: Database operations for asset information and pricing
- **Queue Processing**: Investment/withdrawal request queue management
- **Risk Assessment**: Advanced risk calculation and portfolio optimization
- **gRPC API**: High-performance gRPC service for internal communication
- **HTTP Clients**: RESTful clients for external service integration
- **Database Integration**: Full CRUD operations for assets and queue databases
- **Error Handling**: Comprehensive error handling and retry logic
- **Testing**: Complete unit and integration test coverage (100% success rate)

**API Endpoints**:
- `analyze_market_data()` - Market data analysis and trend prediction
- `process_investment_request()` - Investment request processing workflow
- `execute_asset_management()` - Asset management operations
- `validate_investment_rules()` - Business rule validation
- `get_asset_info()` - Asset information retrieval
- `update_asset_price()` - Real-time price updates
- `process_queue_requests()` - Queue request processing

**Tools Directory**: `src/bank-asset-agent/tools/`
- `market_analyzer.py` - Market data analysis tools
- `rule_validator.py` - Rule validation tools  
- `order_executor.py` - Order execution tools

**Database Clients**: `src/bank-asset-agent/utils/`
- `AssetsDatabaseClient` - Assets database operations
- `QueueDatabaseClient` - Queue database operations
- `BankAssetAgentClient` - Main orchestration client

### 2. DATABASE SERVICES (Implemented)

#### 2.1 Accounts Database (`account-db`)
**Status**: âœ… Implemented
**Purpose**: User account data storage
**Port**: `5432`
**Dependencies**: None (Database service)
**Location**: `src/accounts/accounts-db/`
**Description**: PostgreSQL database storing user accounts, authentication data, and contacts.

#### 2.2 Ledger Database (`ledger-db`)
**Status**: âœ… Implemented
**Purpose**: Transaction ledger storage (append-only)
**Port**: `5432`
**Dependencies**: None (Database service)
**Location**: `src/ledger/ledger-db/`
**Description**: Immutable PostgreSQL database storing all financial transactions.

#### 2.3 Assets Database (`assets-db`)
**Status**: âœ… Implemented
**Purpose**: Investment asset information storage
**Port**: `5432`
**Dependencies**: None (Database service)
**Location**: `src/assets-db/`
**Description**: PostgreSQL database storing investment assets, prices, and availability with comprehensive testing and LLM documentation.

**Key Features**:
- **Asset Management**: Complete CRUD operations for asset data
- **Tier Classification**: Multi-tier asset organization (Tier 1, 2, 3)
- **Price Tracking**: Real-time price updates and historical data
- **Availability Management**: Asset availability and stock tracking
- **Performance Optimization**: Indexed queries and connection pooling
- **Testing Suite**: Comprehensive unit and integration tests
- **LLM Documentation**: Complete API documentation for AI agents

**Schema**:
- `assets` table with columns: `asset_id`, `tier_number`, `asset_name`, `amount`, `price_per_unit`, `last_updated`
- Indexes on `tier_number`, `asset_name`, and `last_updated` for performance
- Constraints for data integrity and validation

**API Integration**:
- Direct PostgreSQL connection via `ASSETS_DB_URI` environment variable
- SQLAlchemy ORM support for Python applications
- Connection pooling and error handling
- Transaction management and rollback capabilities

#### 2.4 Queue Database (`queue-db`)
**Status**: âœ… Implemented
**Purpose**: Investment/withdrawal request queue storage
**Port**: `5432`
**Dependencies**: None (Database service)
**Location**: `src/queue-db/`
**Description**: PostgreSQL database managing investment and withdrawal request queues with comprehensive testing and LLM documentation.

**Key Features**:
- **Queue Management**: Complete CRUD operations for queue entries
- **Multi-Tier Support**: Support for Tier 1, 2, and 3 investment pools
- **Withdrawal Support**: Negative amounts for withdrawal processing
- **Status Tracking**: Request status management (pending, processed, failed)
- **UUID Support**: Unique identifier tracking for requests
- **Performance Optimization**: Indexed queries and connection pooling
- **Testing Suite**: Comprehensive unit and integration tests
- **LLM Documentation**: Complete API documentation for AI agents

**Schema**:
- `investment_queue` table with columns: `queue_id`, `account_number`, `tier_1`, `tier_2`, `tier_3`, `uuid`, `status`, `created_at`, `updated_at`, `processed_at`
- Indexes on `account_number`, `status`, and `created_at` for performance
- Support for negative values in tier columns for withdrawals

**API Integration**:
- Direct PostgreSQL connection via `QUEUE_DB_URI` environment variable
- SQLAlchemy ORM support for Python applications
- Connection pooling and error handling
- Transaction management and rollback capabilities

#### 2.5 User Portfolio Database (`user-portfolio-table`)
**Status**: âœ… Implemented
**Purpose**: User portfolio data storage
**Port**: `5432`
**Dependencies**: None (Database service)
**Location**: `src/user-portfolio-db/`
**Description**: PostgreSQL database storing user portfolios, allocations, and analytics.

### 3. PLANNED SERVICES (To Be Implemented)

#### 3.1 Investment Manager Service (`investment-manager-svc`)
**Status**: ðŸš§ Planned
**Purpose**: Central investment management orchestration
**Port**: `8080`
**Dependencies**: `investments-record-reader-svc`, `user-portfolio-svc`, `invest-svc`, `withdraw-svc`
**Location**: `src/investment-manager/` (to be created)
**Description**: Orchestrates investment operations, manages investment workflows, and coordinates between investment services.


#### 3.3 User Tier Agent (`user-tier-agent`)
**Status**: ðŸš§ Planned
**Purpose**: User tier classification and management
**Port**: `8080`
**Dependencies**: `user-request-queue-svc`
**Location**: `src/user-tier-agent/` (to be created)
**Description**: Manages user tier classifications and determines investment eligibility and limits.

#### 3.4 Investments Record Reader Service (`investments-record-reader-svc`)
**Status**: ðŸš§ Planned
**Purpose**: Investment transaction history and reporting
**Port**: `8080`
**Dependencies**: `portfolio-transaction-table`
**Location**: `src/investments-record-reader/` (to be created)
**Description**: Reads and provides investment transaction history and reporting capabilities.

#### 3.5 Execute Order Service (`execute-order-svc`)
**Status**: ðŸš§ Planned
**Purpose**: Investment order execution
**Port**: `8080`
**Dependencies**: `bank-asset-agent`, `rule-checker-svc`
**Location**: `src/execute-order/` (to be created)
**Description**: Executes investment orders and manages order lifecycle with integration to bank-asset-agent.

**Integration with bank-asset-agent**:
- **HTTP Client**: `ExecuteOrderClient` in `bank-asset-agent/utils/http_client.py`
- **API Endpoints**: `/api/execute`, `/api/orders/{order_id}`, `/api/orders/{order_id}/cancel`
- **Order Management**: Order creation, execution, status tracking, and cancellation
- **Error Handling**: Comprehensive error handling and retry logic
- **Testing**: Integration tests in `bank-asset-agent/tests/test_integration.py`

#### 3.6 User Request Queue Service (`user-request-queue-svc`)
**Status**: ðŸš§ Planned
**Purpose**: Investment request processing and queuing
**Port**: `8080`
**Dependencies**: `bank-asset-agent`, `rule-checker-svc`, `queue-db`
**Location**: `src/user-request-queue/` (to be created)
**Description**: Processes investment and withdrawal requests from the queue database with integration to bank-asset-agent.

**Integration with bank-asset-agent**:
- **HTTP Client**: `UserRequestQueueClient` in `bank-asset-agent/utils/http_client.py`
- **API Endpoints**: `/api/requests`, `/api/process`, `/api/requests/{request_id}`
- **Queue Management**: Request retrieval, processing, and status updates
- **Database Integration**: Direct integration with `queue-db` via `QueueDatabaseClient`
- **Error Handling**: Comprehensive error handling and retry logic
- **Testing**: Integration tests in `bank-asset-agent/tests/test_integration.py`

#### 3.7 User Portfolio Service (`user-portfolio-svc`)
**Status**: ðŸš§ Planned
**Purpose**: Portfolio management operations
**Port**: `8080`
**Dependencies**: `user-portfolio-table`
**Location**: `src/user-portfolio/` (to be created)
**Description**: Manages user portfolio operations, allocations, and updates.

#### 3.8 Invest Service (`invest-svc`)
**Status**: ðŸš§ Planned
**Purpose**: Investment processing and execution
**Port**: `8080`
**Dependencies**: `user-portfolio-table`, `user-tier-agent`, `portfolio-transaction-table`
**Location**: `src/invest/` (to be created)
**Description**: Processes investment requests and updates portfolio allocations.

#### 3.9 Withdraw Service (`withdraw-svc`)
**Status**: ðŸš§ Planned
**Purpose**: Withdrawal processing and execution
**Port**: `8080`
**Dependencies**: `portfolio-transaction-table`, `user-portfolio-table`, `user-request-queue-svc`, `user-return-rules-agent`
**Location**: `src/withdraw/` (to be created)
**Description**: Processes withdrawal requests and manages fund extraction.

#### 3.10 Rule Checker Service (`rule-checker-svc`)
**Status**: ðŸš§ Planned
**Purpose**: Business rule validation and compliance
**Port**: `8080`
**Dependencies**: `bank-asset-agent`, `execute-order-svc`
**Location**: `src/rule-checker/` (to be created)
**Description**: Validates business rules, compliance requirements, and investment constraints with integration to bank-asset-agent.

**Integration with bank-asset-agent**:
- **HTTP Client**: `RuleCheckerClient` in `bank-asset-agent/utils/http_client.py`
- **API Endpoints**: `/api/validate`, `/api/compliance`
- **Rule Validation**: Investment rule checking and compliance validation
- **Risk Assessment**: Risk scoring and validation logic
- **Error Handling**: Comprehensive error handling and retry logic
- **Testing**: Integration tests in `bank-asset-agent/tests/test_integration.py`

#### 3.11 Market Reader Service (`market-reader-svc`)
**Status**: ðŸš§ Planned
**Purpose**: Real-time market data integration
**Port**: `8080`
**Dependencies**: None (External API service)
**Location**: `src/market-reader/` (to be created)
**Description**: Integrates with external market data providers for real-time asset pricing with integration to bank-asset-agent.

**Integration with bank-asset-agent**:
- **HTTP Client**: `MarketReaderClient` in `bank-asset-agent/utils/http_client.py`
- **API Endpoints**: `/api/market-data`, `/api/assets/{symbol}`
- **Market Data**: Real-time market data retrieval and processing
- **Asset Information**: Asset details and pricing information
- **Error Handling**: Comprehensive error handling and retry logic
- **Testing**: Integration tests in `bank-asset-agent/tests/test_integration.py`

#### 3.12 User Return Rules Agent (`user-return-rules-agent`)
**Status**: ðŸš§ Planned
**Purpose**: Return calculation and rule management
**Port**: `8080`
**Dependencies**: None (Standalone service)
**Location**: `src/user-return-rules-agent/` (to be created)
**Description**: Calculates investment returns and manages return-related business rules.

#### 3.13 Portfolio Transaction Table (`portfolio-transaction-table`)
**Status**: ðŸš§ Planned
**Purpose**: Portfolio transaction storage
**Port**: `5432`
**Dependencies**: None (Database service)
**Location**: `src/portfolio-transaction-db/` (to be created)
**Description**: PostgreSQL database storing portfolio-specific transactions and changes.

## Service Communication Patterns

### 1. HTTP REST APIs
- **Authentication**: JWT tokens for application services
- **Database Services**: Direct PostgreSQL connections (no JWT required)
- **Ports**: Application services use 8080, Database services use 5432

### 2. Database Connections
- **Connection Pattern**: `postgresql://username:password@service-name:5432/database-name`
- **Environment Variables**: `{SERVICE_NAME}_DB_URI`
- **Connection Pooling**: Recommended for high-traffic services

### 3. Service Discovery
- **Kubernetes Services**: Services discover each other via Kubernetes service names
- **Internal Communication**: Services communicate within the cluster
- **External APIs**: Market data and external services via HTTP

## Development Guidelines

### 1. Service Creation Template
```bash
src/new-service/
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ k8s/
â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â”œâ”€â”€ config.yaml
â”‚   â”‚   â””â”€â”€ kustomization.yaml
â”‚   â””â”€â”€ overlays/development/
â”‚       â”œâ”€â”€ new-service.yaml
â”‚       â””â”€â”€ kustomization.yaml
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ run_tests.sh
â”‚   â”œâ”€â”€ test_new_service.py
â”‚   â””â”€â”€ test_new_service_integration.py
â”œâ”€â”€ README.md
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ skaffold.yaml
â””â”€â”€ llm.txt
```

### 2. Database Service Template
```bash
src/new-db/
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ initdb/
â”‚   â”œâ”€â”€ 0-schema.sql
â”‚   â””â”€â”€ 1-load-testdata.sh
â”œâ”€â”€ k8s/
â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â”œâ”€â”€ config.yaml
â”‚   â”‚   â””â”€â”€ kustomization.yaml
â”‚   â””â”€â”€ overlays/development/
â”‚       â”œâ”€â”€ new-db.yaml
â”‚       â””â”€â”€ kustomization.yaml
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ run_tests.sh
â”‚   â”œâ”€â”€ test_new_db_docker.sh
â”‚   â””â”€â”€ test_new_db_sql.sh
â”œâ”€â”€ README.md
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ skaffold.yaml
â””â”€â”€ llm.txt
```

### 3. Common Patterns

#### 3.1 Application Service Pattern
```python
# Standard Flask/FastAPI service structure
from flask import Flask, request, jsonify
import jwt
import os

app = Flask(__name__)

def verify_jwt_token(token):
    # JWT verification logic
    pass

@app.route('/api/endpoint', methods=['POST'])
def endpoint():
    # Verify JWT token
    auth_header = request.headers.get('Authorization')
    if not verify_jwt_token(auth_header):
        return jsonify({'error': 'Unauthorized'}), 401
    
    # Process request
    return jsonify({'result': 'success'})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080)
```

#### 3.2 Database Service Pattern
```python
# Standard database service structure
import psycopg2
import os

def get_db_connection():
    return psycopg2.connect(os.environ.get('DB_URI'))

def execute_query(query, params=None):
    conn = get_db_connection()
    cursor = conn.cursor()
    try:
        cursor.execute(query, params)
        result = cursor.fetchall()
        conn.commit()
        return result
    finally:
        cursor.close()
        conn.close()
```

## Implementation Priority

### Phase 1: Core Investment Services
1. `user-portfolio-svc` - Portfolio management
2. `invest-svc` - Investment processing
3. `withdraw-svc` - Withdrawal processing
4. `portfolio-transaction-table` - Transaction storage

### Phase 2: AI and Decision Services
1. `bank-asset-agent` - Asset management AI
2. `user-tier-agent` - User classification
3. `rule-checker-svc` - Business rules
4. `user-return-rules-agent` - Return calculations

### Phase 3: Market and Execution
1. `market-reader-svc` - Market data
2. `execute-order-svc` - Order execution
3. `user-request-queue-svc` - Request processing
4. `investments-record-reader-svc` - Record management

### Phase 4: Orchestration
1. `investment-manager-svc` - Central orchestration

## Testing Strategy

### 1. Unit Tests
- Each service has comprehensive unit tests
- Database services include schema validation tests
- Application services include API endpoint tests
- **bank-asset-agent**: 100% unit test success rate (12/12 tests passed)
- **assets-db**: Comprehensive Docker-based testing with schema validation
- **queue-db**: Complete testing suite with constraint validation

### 2. Integration Tests
- Service-to-service communication tests
- Database integration tests
- End-to-end workflow tests
- **bank-asset-agent**: 100% integration test success rate (8/8 tests passed)
- **Database Integration**: Full CRUD operations testing
- **API Integration**: HTTP client and gRPC service testing

### 3. Performance Tests
- Load testing with `loadgen`
- Database performance monitoring
- Service response time monitoring
- **Connection Pooling**: Optimized database connections
- **Retry Logic**: Exponential backoff for failed requests
- **Error Handling**: Comprehensive error recovery mechanisms

### 4. Testing Infrastructure
- **Docker-based Testing**: Containerized test environments
- **Mock Services**: Comprehensive mocking for external dependencies
- **Test Data**: Realistic test data generation and management
- **CI/CD Integration**: Automated testing in deployment pipelines

## Deployment Strategy

### 1. Development
```bash
# Deploy specific service
skaffold dev --module service-name

# Deploy all services
skaffold dev
```

### 2. Production
```bash
# Deploy to production
skaffold run --profile production

# Deploy specific service
skaffold run --module service-name --profile production
```

## Monitoring and Observability

### 1. Service Health
- Health check endpoints for all services
- Kubernetes liveness and readiness probes
- Service dependency monitoring

### 2. Performance Metrics
- Request/response times
- Database query performance
- Service resource utilization

### 3. Business Metrics
- Investment transaction volumes
- Portfolio performance tracking
- User activity monitoring

## Security Considerations

### 1. Authentication
- JWT tokens for all application services
- Database services use network-level security
- Service-to-service authentication

### 2. Data Protection
- Encrypted data in transit
- Secure database connections
- Input validation and sanitization

### 3. Compliance
- Financial data audit trails
- Transaction immutability
- Regulatory compliance features

## LLM Documentation and AI Agent Integration

### 1. LLM Documentation Files
Each service includes comprehensive `llm.txt` files for AI agent interaction:

#### 1.1 Database Services
- **assets-db/llm.txt**: Complete database schema, API usage, and integration patterns
- **queue-db/llm.txt**: Queue management operations and database interactions
- **accounts-db/llm.txt**: User account management and authentication patterns
- **ledger-db/llm.txt**: Transaction ledger operations and data integrity
- **user-portfolio-db/llm.txt**: Portfolio management and analytics operations

#### 1.2 Application Services
- **bank-asset-agent/llm.txt**: Comprehensive AI agent documentation with tools, APIs, and workflows
- **master_llm.txt**: Central architectural blueprint for all microservices

### 2. AI Agent Capabilities
The `bank-asset-agent` provides advanced AI capabilities:

#### 2.1 Market Analysis Tools
- Real-time market data processing
- Trend analysis and prediction
- Risk assessment and scoring
- Portfolio optimization algorithms

#### 2.2 Investment Decision Making
- Rule-based investment validation
- Compliance checking and reporting
- Order execution and management
- Queue processing and workflow automation

#### 2.3 Database Integration
- Direct database operations via specialized clients
- Transaction management and rollback capabilities
- Connection pooling and error handling
- Performance optimization and monitoring

### 3. Service Integration Patterns
- **HTTP Clients**: RESTful API integration with retry logic
- **gRPC Services**: High-performance internal communication
- **Database Clients**: Direct database access with connection management
- **Error Handling**: Comprehensive error recovery and logging

## Future Enhancements

### 1. Advanced AI Features
- Machine learning models for investment recommendations
- Predictive analytics for market trends
- Automated portfolio rebalancing
- **Enhanced Tools**: Additional AI tools in `bank-asset-agent/tools/`
- **Model Integration**: ML model deployment and inference
- **Real-time Learning**: Continuous model updates and improvement

### 2. Real-time Capabilities
- WebSocket connections for real-time updates
- Event-driven architecture
- Real-time market data streaming
- **Live Updates**: Real-time asset price updates
- **Event Streaming**: Kafka or similar event streaming integration
- **WebSocket APIs**: Real-time client communication

### 3. Scalability Improvements
- Horizontal scaling capabilities
- Database sharding strategies
- Caching layers for performance
- **Microservice Scaling**: Independent scaling of services
- **Database Optimization**: Query optimization and indexing
- **Caching Strategy**: Redis or similar caching layer

### 4. AI Agent Enhancements
- **Multi-Agent Systems**: Coordination between multiple AI agents
- **Natural Language Processing**: Conversational interfaces
- **Advanced Analytics**: Deep learning models for market analysis
- **Automated Trading**: Fully automated investment strategies

This master architecture provides a comprehensive blueprint for building and extending the Bank of Anthos platform with clear service definitions, dependencies, implementation guidelines, and AI agent integration capabilities.
